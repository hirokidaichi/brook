Namespace('brook').define(function(ns){var VERSION="0.01";var Promise=function(next){this.next=next||function(next,val){return next(val);};};(function(proto){proto.concat=function(promise){var _before=this;var after=promise;var next=function(n,val){return _before.subscribe(promise.ready(n),val);};return new Promise(next);};proto.bind=function(){var r=this;for(var i=0,l=arguments.length;i<l;i++){var s=arguments[i];s=(s instanceof Promise)?s:promise(s);r=r.concat(s);}
return r;};proto.ready=function(n){var proc=this.next;return function(val){return proc(n,val);};};proto.run=function(val){this.subscribe(undefined,val);};proto.subscribe=function(next,val){var next=next?next:function(){};if(!this.errorHandler)
return this.next(next,val);try{this.next(next,val);}
catch(e){this.onError(e);}};proto.forEach=proto.subscribe;proto.setErrorHandler=function(promise){this.errorHandler=promise;};proto.onError=function(e){(this.errorHandler||new Promise).subscribe(function(){},e);};})(Promise.prototype);var promise=function(next){return new Promise(next)};ns.provide({promise:promise,VERSION:VERSION});});Namespace('brook.util')
.use('brook promise')
.define(function(ns){var mapper=function(f){return ns.promise(function(next,val){return next(f(val));});};var filter=function(f){return ns.promise(function(next,val){if(f(val))return next(val);});};var takeBy=function(by){var num=1;var queue=[];return ns.promise(function(next,val){queue.push(val);if(num++%(by)==0){next(queue);queue=[];}});};var scatter=function(){return ns.promise(function(next,val){for(var i=0,l=val.length;i<l;i++){next(val[i]);}});};var wait=function(msec){var msecFunc=(typeof msec=='function')?msec:function(){return msec};return ns.promise(function(next,val){setTimeout(function(){next(val);},msecFunc());});};var waitUntil=function(f){var p=function(next,val){if(f()){return next(val);}
setTimeout(function(){p(next,val)},100);};return ns.promise(p);};var debug=function(sig){var sig=sig?sig:"debug";return ns.promise(function(next,val){console.log(sig+":",val);return next(val);});};var cond=function(f,promise){return ns.promise(function(next,val){if(!f(val))
return next(val);promise.subscribe(function(val){return next(val);},val);});};var match=function(dispatchTable){return ns.promise(function(next,val){var promise=dispatchTable[val]||dispatchTable['__default__']||ns.promise();promise.subscribe(function(v){next(v);},val);});};var LOCK_MAP={};var unlock=function(name){return ns.promise(function(next,val){LOCK_MAP[name]=false;next(val);});};var lock=function(name){var tryLock=(function(next,val){if(!LOCK_MAP[name]){LOCK_MAP[name]=true;return next(val);}
setTimeout(function(){tryLock(next,val);},100);});return ns.promise(tryLock);};var from=function(value){if(value.observe){return ns.promise(function(next,val){value.observe(ns.promise(function(n,v){next(v);}));});}
return ns.promise(function(next,val){next(value);});};var emitInterval=function(msec){var msecFunc=(typeof msec=='function')?msec:function(){return msec};return ns.promise(function(next,val){var id=setInterval(function(){next(val);},msecFunc());});};ns.provide({mapper:mapper,filter:filter,scatter:scatter,takeBy:takeBy,wait:wait,cond:cond,match:match,debug:debug,lock:lock,unlock:unlock,from:from,waitUntil:waitUntil,emitInterval:emitInterval});});Namespace('brook.lamda')
.define(function(ns){var cache={};var hasArg=function(expression){return expression.indexOf('->')>=0;};var parseExpression=function(expression){var fixed=hasArg(expression)?expression:"$->"+expression;var splitted=fixed.split("->");var argsExp=splitted.shift();var bodyExp=splitted.join('->');return{argumentNames:argsExp.split(','),body:hasArg(bodyExp)?lamda(bodyExp).toString():bodyExp};};var lamda=function(expression){if(cache[expression])
return cache[expression];var parsed=parseExpression(expression);var func=new Function(parsed.argumentNames,"return ("+parsed.body+");");cache[expression]=func;return func;};ns.provide({lamda:lamda});});Namespace('brook.channel')
.use('brook promise')
.define(function(ns){var Channel=function(){this.queue=[];this.promises=[];};(function(proto){var through=function(k){return k};proto.sendMessage=function(msg){this.queue.push(msg);while(this.queue.length){var v=this.queue.shift();for(var i=0,l=this.promises.length;i<l;i++){this.promises[i].run(v);}}};proto.send=function(func){var func=(func)?func:through;var _self=this;return ns.promise(function(next,val){_self.sendMessage(func(val));next(val);});};proto.observe=function(promise){this.promises.push(promise);};})(Channel.prototype);var channel=function(name){if(name)
return getNamedChannel(name);return new Channel;};var NAMED_CHANNEL={};var getNamedChannel=function(name){if(NAMED_CHANNEL[name])
return NAMED_CHANNEL[name];NAMED_CHANNEL[name]=new Channel;return NAMED_CHANNEL[name];};var observeChannel=function(name,promise){getNamedChannel(name).observe(promise);};var sendChannel=function(name,func){var channel=getNamedChannel(name);return channel.send(func);};ns.provide({channel:channel,sendChannel:sendChannel,observeChannel:observeChannel,createChannel:function(){return new Channel;}});});Namespace('brook.model')
.use('brook promise')
.use('brook.util *')
.use('brook.channel *')
.use('brook.lamda *')
.define(function(ns){var Model=function(obj){this.methods={};this.channels={};for(var prop in obj){if(!obj.hasOwnProperty(prop))
continue;this.addMethod(prop,obj[prop]);}};Model.prototype.addMethod=function(method,promise){if(this.methods[method])
throw('already '+method+' defined');var channel=ns.createChannel();this.methods[method]=promise.bind(channel.send());this.channels[method]=channel;return this;};Model.prototype.notify=function(method){return ns.promise().bind(this.methods[method]);};Model.prototype.method=function(method){if(!this.channels[method])
throw('do not observe undefined method');return this.channels[method];};var createModel=function(){return new Model;};ns.provide({createModel:createModel});});Namespace("brook.view.htmltemplate.core")
.define(function(ns){var module={exports:{}};var util={};util.defineClass=function(obj,superClass){var klass=function Klass(){this.initialize.apply(this,arguments);};if(superClass)klass.prototype=new superClass;for(var prop in obj){if(!obj.hasOwnProperty(prop))
continue;klass.prototype[prop]=obj[prop];}
if(!klass.prototype.initialize)
klass.prototype.initalize=function(){};return klass;};util.merge=function(origin,target){for(var prop in target){if(!target.hasOwnProperty(prop))
continue;origin[prop]=target[prop];}};util.k=function(k){return k};util.emptyFunction=function(){};util.listToArray=function(list){return Array.prototype.slice.call(list);};util.curry=function(){var args=util.listToArray(arguments);var f=args.shift();return function(){return f.apply(this,args.concat(util.listToArray(arguments)));}};util.merge(util,{isArray:function(object){return object!=null&&typeof object=="object"&&'splice'in object&&'join'in object;},isFunction:function(object){return typeof object=="function";},isString:function(object){return typeof object=="string";},isNumber:function(object){return typeof object=="number";},isUndefined:function(object){return typeof object=="undefined";}});util.createRegexMatcher=function(escapeChar,expArray){function _escape(regText){return(regText+'').replace(new RegExp(escapeChar,'g'),"\\");}
var count=0;var e;var regValues={mapping:{'fullText':[0]},text:[]};for(var i=0,l=expArray.length;i<l;i++){e=expArray[i];if(util.isString(e)){regValues.text.push(e);continue;}
if(!regValues.mapping[e.map]){regValues.mapping[e.map]=[];}
regValues.mapping[e.map].push(++count);}
var reg=undefined;regValues.text=_escape(regValues.text.join(''));return function matcher(matchingText){if(!reg){reg=new RegExp(regValues.text);}
var results=(matchingText||'').match(reg);if(results){var ret={};var prop=0,i=0,map=regValues.mapping;for(prop in map){var list=map[prop];var length=list.length;for(i=0;i<length;i++){if(results[list[i]]){ret[prop]=results[list[i]];break;}}}
return ret;}else{return undefined;}};};var CHUNK_REGEXP_ATTRIBUTE=util.createRegexMatcher('%',["<","(%/)?",{map:'close'},"TMPL_","(VAR|LOOP|IF|ELSE|ELSIF|UNLESS|INCLUDE)",{map:'tag_name'},"%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:'default'},'"([^">]*)"|',{map:'default'},"([^%s=>]*)",{map:'default'},")",")?","%s*","(?:","(?:ESCAPE)=","(?:","(JS|URL|HTML|0|1|NONE)",{map:'escape'},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:'default'},'"([^">]*)"|',{map:'default'},"([^%s=>]*)",{map:'default'},")",")?","%s*","(?:","(NAME|EXPR)=",{map:'attribute_name'},"(?:","'([^'>]*)'|",{map:'attribute_value'},'"([^">]*)"|',{map:'attribute_value'},"([^%s=>]*)",{map:'attribute_value'},")",")?",'%s*',"(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:'default'},'"([^">]*)"|',{map:'default'},"([^%s=>]*)",{map:'default'},")",")?","%s*","(?:","(?:ESCAPE)=","(?:","(JS|URL|HTML|0|1|NONE)",{map:'escape'},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:'default'},'"([^">]*)"|',{map:'default'},"([^%s=>]*)",{map:'default'},")",")?","%s*",">"]);var element={};element.Base=util.defineClass({initialize:function(option){this.mergeOption(option);},mergeOption:function(option){util.merge(this,option);this['isCloseTag']=(this['isCloseTag'])?true:false;},isParent:util.emptyFunction,execute:util.emptyFunction,getCode:function(e){return"void(0);";},toString:function(){return['<',((this.isCloseTag)?'/':''),this.type,((this.hasName)?' NAME=':''),((this.name)?this.name:''),'>'].join('');},_pathLike:function(attribute,matched){var pos=(matched=='/')?'0':'$_C.length -'+(matched.split('..').length-1);return["(($_C["+pos+"]['",attribute,"']) ? $_C["+pos+"]['",attribute,"'] : undefined )"].join('');},getParam:function(){var ret="";if(this.attributes['name']){var matched=this.attributes['name'].match(/^(\/|(?:\.\.\/)+)(\w+)/);if(matched){return this._pathLike(matched[2],matched[1]);}
var _default=(this.attributes['default'])?"'"+this.attributes['default']+"'":"undefined";ret=["(($_T['",this.attributes['name'],"']) ? $_T['",this.attributes['name'],"'] : ",_default," )"].join('');}
if(this.attributes['expr']){var operators={'gt':'>','lt':'<','eq':'==','ne':'!=','ge':'>=','le':'<='};var replaced=this.attributes['expr'].replace(/{(\/|(?:\.\.\/)+)(\w+)}/g,function(full,matched,param){return['$_C[',(matched=='/')?'0':'$_C.length -'+(matched.split('..').length-1),']["',param,'"]'].join('');}).replace(/\s+(gt|lt|eq|ne|ge|le|cmp)\s+/g,function(full,match){return" "+operators[match]+" ";});ret=["(function(){","    with($_F){","        with($_T){","            return (",replaced,');',"}}})()"].join('');}
if(this.attributes['escape']){var _escape={NONE:'NONE',0:'NONE',1:'HTML',HTML:'HTML',JS:'JS',URL:'URL'}[this.attributes['escape']];ret=['$_F.__escape'+_escape+'(',ret,')'].join('');}
return ret;}});var cache={STRING_FRAGMENT:[]};util.merge(element,{ROOTElement:util.defineClass({type:'root',getCode:function(){if(this.isCloseTag){return'return $_R.join("");';}else{return['var $_R  = [];','var $_C  = [param];','var $_F  = funcs||{};','var $_T  = param||{};','var $_S  = cache.STRING_FRAGMENT;',].join('');}}},element.Base),LOOPElement:util.defineClass({type:'loop',initialize:function(option){this.mergeOption(option);},getLoopId:function(){if(this._ID){return this._ID;}
if(!element.LOOPElement.instanceId){element.LOOPElement.instanceId=0;}
var id=element.LOOPElement.instanceId++;this._ID='$'+id.toString(16);return this._ID;},getCode:function(){if(this.isCloseTag){return['}','$_T = $_C.pop();'].join('');}else{var id=this.getLoopId();return['var $_L_'+id+' ='+this.getParam()+'|| [];','var $_LL_'+id+' = $_L_'+id+'.length;','$_C.push($_T);','for(var i_'+id+'=0;i_'+id+'<$_LL_'+id+';i_'+id+'++){','   $_T = (typeof $_L_'+id+'[i_'+id+'] == "object")?','                $_L_'+id+'[i_'+id+'] : {};',"$_T['__first__'] = (i_"+id+" == 0) ? true: false;","$_T['__counter__'] = i_"+id+"+1;","$_T['__odd__']   = ((i_"+id+"+1)% 2) ? true: false;","$_T['__last__']  = (i_"+id+" == ($_LL_"+id+" - 1)) ? true: false;","$_T['__inner__'] = ($_T['__first__']||$_T['__last__'])?false:true;"].join('');}}},element.Base),VARElement:util.defineClass({type:'var',getCode:function(){if(this.isCloseTag){throw(new Error('HTML.Template ParseError TMPL_VAR'));}else{return'$_R.push('+this.getParam()+');';}}},element.Base),IFElement:util.defineClass({type:'if',getCondition:function(param){return"!!"+this.getParam(param);},getCode:function(){if(this.isCloseTag){return'}';}else{return'if('+this.getCondition()+'){';}}},element.Base),ELSEElement:util.defineClass({type:'else',getCode:function(){if(this.isCloseTag){throw(new Error('HTML.Template ParseError No Close Tag for TMPL_ELSE'));}else{return'}else{';}}},element.Base),INCLUDEElement:util.defineClass({type:'include',getCode:function(){if(this.isCloseTag){throw(new Error('HTML.Template ParseError No Close Tag for TMPL_INCLUDE'));}else{var name='"'+(this.attributes['name'])+'"';return['$_R.push($_F.__include(',name,',$_T,$_F));'].join('\n');}}},element.Base),TEXTElement:util.defineClass({type:'text',isCloseTag:false,initialize:function(option){this.value=option;},getCode:function(){if(this.isCloseTag){throw(new Error('HTML.Template ParseError No Close Tag for TEXT'));}else{cache.STRING_FRAGMENT.push(this.value);return'$_R.push($_S['+(cache.STRING_FRAGMENT.length-1)+']);';}}},element.Base)});element.ELSIFElement=util.defineClass({type:'elsif',getCode:function(){if(this.isCloseTag){throw(new Error('HTML.Template ParseError No Close Tag for TMPL_ELSIF'));}else{return'}else if('+this.getCondition()+'){';}}},element.IFElement);element.UNLESSElement=util.defineClass({type:'unless',getCondition:function(param){return"!"+this.getParam(param);}},element.IFElement);element.createElement=function(type,option){return new element[type+'Element'](option);};var parseHTMLTemplate=function(source){var chunks=[];var createElement=element.createElement;var root=createElement('ROOT',{isCloseTag:false});var matcher=CHUNK_REGEXP_ATTRIBUTE;chunks.push(root);while(source.length>0){var results=matcher(source);if(!results){chunks.push(createElement('TEXT',source));source='';break;}
var index=0;var fullText=results.fullText;if((index=source.indexOf(fullText))>0){var text=source.slice(0,index);chunks.push(createElement('TEXT',text));source=source.slice(index);};var attr,name,value;if(results.attribute_name){name=results.attribute_name.toLowerCase();value=results.attribute_value;attr={};attr[name]=value;attr['default']=results['default'];attr['escape']=results['escape'];}else{attr=undefined;}
chunks.push(createElement(results.tag_name,{'attributes':attr,'isCloseTag':results.close,'parent':this}));source=source.slice(fullText.length);};chunks.push(createElement('ROOT',{isCloseTag:true}));return chunks;};module.exports.getFunctionText=function(chunksOrSource){var chunks=util.isString(chunksOrSource)?parseHTMLTemplate(chunksOrSource):chunksOrSource;var codes=[];for(var i=0,l=chunks.length;i<l;i++){codes.push(chunks[i].getCode());}
return codes.join('\n');};module.exports.compileFunctionText=function(functionText){return util.curry(new Function('cache','param','funcs',functionText),cache);};ns.provide(module.exports);});Namespace('brook.view.htmltemplate')
.use('brook.view.htmltemplate.core *')
.define(function(ns){var merge=function(origin,target){for(var prop in target){if(!target.hasOwnProperty(prop))
continue;origin[prop]=target[prop];}};var meta={'\b':'\\b','\t':'\\t','\n':'\\n','\f':'\\f','\r':'\\r','"':'\\"','\\':'\\\\'};var _map=function(list,mapper){var result=[];for(var i=0,l=list.length;i<l;i++){result.push(mapper(list[i]));}
return result;};var quote=function(str){return'"'+_map(str.split(''),function(e){return meta[e]?meta[e]:e;}).join('')+'"';};var GLOBAL_FUNC={__escapeHTML:function(str){return str
.toString()
.replace(/&/g,'&amp;')
.replace(/</g,'&lt;')
.replace(/>/g,'&gt;')
.replace(/'/g,'&#039;')
.replace(/"/g,'&quot;');},__escapeJS:function(str){return quote(str);},__escapeURL:function(str){return encodeURI(str);},__escapeNONE:function(str){return str;},__include:function(name,param,func){var tmpl=Klass.getByElementId(name);if(!tmpl){return;}
tmpl.param(param);tmpl.registerFunction(func);return tmpl.output();}};var Klass=function _HTMLTemplate(func){this._param={};this._funcs={};merge(this._funcs,GLOBAL_FUNC);this._output=func;};merge(Klass.prototype,{param:function(obj){merge(this._param,obj);},registerFunction:function(name,func){this._funcs[name]=func;},output:function(){return this._output(this._param,this._funcs);}});var COMMENT_NODE=('Node'in window)?Node.COMMENT_NODE:8;var _getSourceFromElement=function(element){var children=element.childNodes||[];var result=[];for(var i=0,l=children.length;i<l;i++){var e=children[i];if(e.nodeType!=COMMENT_NODE){continue;}
result.push(e.data);}
return result.join('');};var _getFunctionTextFromElement=function(element){var elementId=element.id;return ns.getFunctionText(_getSourceFromElement(element));};merge(Klass,{cache:{},get:function(source){var uniqId='autocache:'+Klass.hashFunction(source);var func=Klass.resolve(uniqId);if(func)
return new Klass(func);var functionBody=ns.getFunctionText(source);var outputFunction=ns.compileFunctionText(functionBody);return new Klass(Klass.reserve(uniqId,outputFunction));},resolve:function(name){return Klass.cache[name];},reserve:function(name,outputFunction){Klass.cache[name]=outputFunction;return Klass.cache[name];},getByElementId:function(elementId){var uniqId='dom:'+elementId;var func=Klass.resolve(uniqId);if(func){return new Klass(func);}
var element=document.getElementById(elementId);if(!element){return undefined;}
var functionBody=_getFunctionTextFromElement(element);var outputFunction=ns.compileFunctionText(functionBody);return new Klass(Klass.reserve(uniqId,outputFunction));},hashFunction:function(string){var max=(1<<31);var length=string.length;var ret=34351;var pos='x';for(var i=0;i<length;i++){var c=string.charCodeAt(i);ret*=37;pos^=c;ret+=c;ret%=max;}
return ret.toString(16)+'-'+(pos&0x00ff).toString(16);},registerFunction:function(name,func){GLOBAL_FUNC[name]=func;}});ns.provide({HTMLTemplate:Klass});});Namespace('brook.dom.compat')
.define(function(ns){var dataset=(function(){var wrapper=function(element){return element.dataset;};if(window["HTMLElemenT"]&&HTMLElement.prototype){var proto=HTMLElement.prototype;if(proto.dataset)
return wrapper;if(proto.__lookupGetter__&&proto.__lookupGetter__('dataset'))
return wrapper;}
var camelize=function(string){return string.replace(/-+(.)?/g,function(match,chr){return chr?chr.toUpperCase():'';});};return function(element){var sets={};for(var i=0,a=element.attributes,l=a.length;i<l;i++){var attr=a[i];if(!attr.name.match(/^data-/))continue;sets[camelize(attr.name.replace(/^data-/,''))]=attr.value;}
return sets;};})();var ClassList=function(element){this._element=element;this._refresh();};var classList=function(element){return new ClassList(element);};ClassList.prototype=new Array;(function(proto){var check=function(token){if(token==""){throw"SYNTAX_ERR";}
if(token.indexOf(/\s/)!=-1){throw"INVALID_CHARACTER_ERR";}};this._fake=true;this._refresh=function(){var clss=this._element.getAttribute("class");if(!clss){return this;}
var classes=clss.split(/\s+/);if(classes.length&&classes[0]==""){classes.shift();}
if(classes.length&&classes[classes.length-1]==""){classes.pop();}
this.length=classes.length;if(this.length==0){return this;}
for(var i=0;i<this.length;++i){this[i]=classes[i];}
return this;};this.item=function(i){return this[i]||null;}
this.contains=function(token){check(token);for(var i=0;i<this.length;++i){if(this[i]==token){return true;}}
return false;}
this.add=function(token){check(token);for(var i=0;i<this.length;++i){if(this[i]==token){return;}}
this.push(token);this._element.setAttribute("class",this.join(" "));}
this.remove=function(token){check(token);for(var i=0;i<this.length;++i){if(this[i]==token){this.splice(i,1);this._element.setAttribute("class",this.join(" "));}}}
this.toggle=function(token){check(token);for(var i=0;i<this.length;++i){if(this[i]==token){this.remove(token);return false;}}
this.add(token);return true;}}).apply(ClassList.prototype);var hasClassName=function(element,className){var classSyntax=element.className;if(!(classSyntax&&className))return false;return(new RegExp("(^|\\s)"+className+"(\\s|$)").test(classSyntax));};var getElementsByClassName=function(className){if(document.getElementsByClassName)return document.getElementsByClassName(className);var allElements=document.getElementsByTagName('*');var ret=[];for(var i=0,l=allElements.length;i<l;i++){if(!hasClassName(allElements[i],className))
continue;ret.push(allElements[i])}
return ret;};ns.provide({getElementsByClassName:getElementsByClassName,hasClassName:hasClassName,dataset:dataset,classList:classList});});Namespace('brook.dom.gateway')
.define(function(ns){ns.provide({});});Namespace('brook.widget')
.use('brook promise')
.use('brook.channel *')
.use('brook.util *')
.use('brook.dom.compat *')
.define(function(ns){var TARGET_CLASS_NAME='widget';var classList=ns.classList;var dataset=ns.dataset;var channel=ns.channel;var removeClassName=function(className,element){classList(element).remove(className);};var elementsByClassName=ns.promise(function(n,v){v=v||TARGET_CLASS_NAME;n([v,Array.prototype.slice.call(ns.getElementsByClassName(v))]);});var mapByNamespace=ns.promise(function(n,val){var targetClassName=val[0];var widgetElements=val[1];var map={};for(var i=0,l=widgetElements.length;i<l;i++){var widget=widgetElements[i];removeClassName((targetClassName||TARGET_CLASS_NAME),widget);var dataset=ns.dataset(widget);if(!dataset.widgetNamespace)continue;if(!map[dataset.widgetNamespace])map[dataset.widgetNamespace]=[];map[dataset.widgetNamespace].push(widget);}
n(map);});var registerElements=ns.promise(function(n,map){for(var namespace in map){if(!map.hasOwnProperty(namespace))continue;var targets=map[namespace];Namespace.use([namespace,'*'].join(' ')).apply(function(_ns){if(_ns.registerElement){for(var i=0,l=targets.length;i<l;i++){_ns.registerElement(targets[i]);}}else if(_ns.registerElements){_ns.registerElements(targets);}else{throw('registerElement or registerElements not defined in '+namespace);}});}});var bindAllWidget=ns.sendChannel('widget');var updater=ns.from(channel('widget'))
.bind(ns.lock('class-seek'))
.bind(elementsByClassName)
.bind(mapByNamespace)
.bind(ns.unlock('class-seek'))
.bind(registerElements);updater.subscribe();ns.provide({bindAllWidget:bindAllWidget});});Namespace('brook.dom.event')
.use('brook promise')
.define(function(ns){});