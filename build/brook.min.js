Namespace("brook").define(function(a){var b="0.01",c=function(a){this.next=a||function(a,b){return a(b)}};(function(a){a.concat=function(a){var b=this,d=function(c,d){return b.subscribe(a.ready(c),d)};return new c(d)},a.bind=function(){var a=this;for(var b=0,e=arguments.length;b<e;b++){var f=arguments[b];f=f instanceof c?f:d(f),a=a.concat(f)}return a},a.ready=function(a){var b=this;return function(c){return b.subscribe(a,c)}},a.run=function(a){this.subscribe(undefined,a)},a.subscribe=function(a,b){a=a?a:function(){};if(!this.errorHandler)return this.next(a,b);try{this.next(a,b)}catch(c){this.onError(c)}},a.forEach=a.subscribe,a.setErrorHandler=function(a){this.errorHandler=a},a.onError=function(a){(this.errorHandler||new c).subscribe(function(){},a)}})(c.prototype);var d=function(a){return new c(a)};a.provide({promise:d,VERSION:b})}),Namespace("brook.util").use("brook promise").define(function(a){var b=function(b){return a.promise(function(a,c){return a(b(c))})},c=function(b){return a.promise(function(a,c){return b(c),a(c)})},d=function(b){return a.promise(function(a,c){if(b(c))return a(c)})},e=function(b){var c=1,d=[];return a.promise(function(a,e){d.push(e),c++%b===0&&(a(d),d=[])})},f=Date.now?function(){return Date.now()}:function(){return+(new Date)},g=function(a,b,c){var d=0,e=a.length;(function(){var g=f();while(e>d&&c>f()-g)b(a[d++]);e>d&&setTimeout(arguments.callee,10)})()},h=function(b){return a.promise(function(a,c){g(c,a,b||400)})},i=function(b){var c=typeof b=="function"?b:function(){return b};return a.promise(function(a,b){setTimeout(function(){a(b)},c())})},j=function(b){var c=function(a,d){if(b())return a(d);setTimeout(function(){c(a,d)},100)};return a.promise(c)},k=function(a){return a=a?a:"debug",c(function(b){console.log(a+":",b)})},l=function(b,c){return a.promise(function(a,d){if(!b(d))return a(d);c.subscribe(function(b){return a(b)},d)})},m=function(b){return a.promise(function(c,d){var e=b[d]||b.__default__||a.promise();e.subscribe(function(a){c(a)},d)})},n={},o=function(b){return a.promise(function(a,c){n[b]=!1,a(c)})},p=function(b){var c=function(a,d){if(!n[b])return n[b]=!0,a(d);setTimeout(function(){c(a,d)},100)};return a.promise(c)},q=function(b){return b.observe?a.promise(function(c,d){b.observe(a.promise(function(a,b){c(b)}))}):a.promise(function(a,c){a(b)})},r={},s=function(b,c){var d=typeof b=="function"?b:function(){return b};return a.promise(function(a,b){var e=setInterval(function(){a(b)},d());c&&(r[c]=e)})},t=function(b){return a.promise(function(a,c){clearInterval(r[b]),a(c)})};a.provide({mapper:b,through:c,filter:d,scatter:h,takeBy:e,wait:i,cond:l,match:m,debug:k,lock:p,unlock:o,from:q,waitUntil:j,emitInterval:s,stopEmitInterval:t})}),Namespace("brook.lambda").define(function(a){var b={},c=function(a){return a.indexOf("->")>=0},d=function(a){var b=c(a)?a:"$->"+a,d=b.split("->"),f=d.shift(),g=d.join("->");return{argumentNames:f.split(","),body:c(g)?e(g).toString():g}},e=function(a){if(b[a])return b[a];var c=d(a),e=new Function(c.argumentNames,"return ("+c.body+");");return b[a]=e,e};a.provide({lambda:e})}),Namespace("brook.channel").use("brook promise").use("brook.util scatter").define(function(a){var b=function(a,b){for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},c=function(){this.queue=[],this.promises=[]};(function(c){var d=function(a){return a};c.send=function(b){b=b?b:d;var c=this;return a.promise(function(a,d){c.sendMessage(b(d)),a(d)})},c.sendMessage=function(b){var c=a.scatter(1e3),d=i("error");this.queue.push(b);var e=function(b){return a.promise(function(a,c){c.run(b)})};while(this.queue.length){var f=this.queue.shift(),g=e(f);g.setErrorHandler(d),c.bind(g).run(this.promises)}},c.observe=function(a){if(b(this.promises,a)>-1)return;this.promises.push(a)},c.stopObserving=function(a){var c=b(this.promises,a);c>-1&&this.promises.splice(c,1)}})(c.prototype);var d=function(a){return a?f(a):new c},e={},f=function(a){return e[a]?e[a]:(e[a]=new c,e[a])},g=function(a,b){f(a).observe(b)},h=function(a,b){f(a).stopObserving(b)},i=function(a,b){var c=f(a);return c.send(b)};a.provide({channel:d,sendChannel:i,observeChannel:g,stopObservingChannel:h,createChannel:function(){return new c}})}),Namespace("brook.model").use("brook promise").use("brook.util *").use("brook.channel *").use("brook.lambda *").define(function(a){var b=function(a){this.methods={},this.channels={};for(var b in a){if(!a.hasOwnProperty(b))continue;this.addMethod(b,a[b])}};b.prototype.addMethod=function(b,c){if(this.methods[b])throw"already "+b+" defined";var d=a.createChannel();return this.methods[b]=c.bind(d.send()),this.channels[b]=d,this},b.prototype.notify=function(b){return a.promise().bind(this.methods[b])},b.prototype.method=function(a){if(!this.channels[a])throw"do not observe undefined method";return this.channels[a]};var c=function(a){return new b(a)};a.provide({createModel:c})}),Namespace("brook.view.htmltemplate.core").define(function(a){var b={exports:{}},c={};c.defineClass=function(a,b){var c=function(){this.initialize.apply(this,arguments)};b&&(c.prototype=new b);for(var d in a){if(!a.hasOwnProperty(d))continue;c.prototype[d]=a[d]}return c.prototype.initialize||(c.prototype.initalize=function(){}),c},c.merge=function(a,b){for(var c in b){if(!b.hasOwnProperty(c))continue;a[c]=b[c]}},c.k=function(a){return a},c.emptyFunction=function(){},c.listToArray=function(a){return Array.prototype.slice.call(a)},c.curry=function(){var a=c.listToArray(arguments),b=a.shift();return function(){return b.apply(this,a.concat(c.listToArray(arguments)))}},c.merge(c,{isArray:function(a){return a!==null&&typeof a=="object"&&"splice"in a&&"join"in a},isFunction:function(a){return typeof a=="function"},isString:function(a){return typeof a=="string"},isNumber:function(a){return typeof a=="number"},isUndefined:function(a){return typeof a=="undefined"}}),c.createRegexMatcher=function(a,b){function d(b){return(b+"").replace(new RegExp(a,"g"),"\\")}var e=0,f,g={mapping:{fullText:[0]},text:[]};for(var h=0,i=b.length;h<i;h++){f=b[h];if(c.isString(f)){g.text.push(f);continue}g.mapping[f.map]||(g.mapping[f.map]=[]),g.mapping[f.map].push(++e)}var j;return g.text=d(g.text.join("")),function(a){j||(j=new RegExp(g.text));var b=(a||"").match(j);if(b){var c={},d=0,e=0,f=g.mapping;for(d in f){var h=f[d],i=h.length;for(e=0;e<i;e++)if(b[h[e]]){c[d]=b[h[e]];break}}return c}return undefined}};var d=c.createRegexMatcher("%",["<","(%/)?",{map:"close"},"TMPL_","(VAR|LOOP|IF|ELSE|ELSIF|UNLESS|INCLUDE)",{map:"tag_name"},"%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*","(?:","(?:ESCAPE)=","(?:","(JS|URL|HTML|0|1|NONE)",{map:"escape"},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*","(?:","(NAME|EXPR)=",{map:"attribute_name"},"(?:","'([^'>]*)'|",{map:"attribute_value"},'"([^">]*)"|',{map:"attribute_value"},"([^%s=>]*)",{map:"attribute_value"},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*","(?:","(?:ESCAPE)=","(?:","(JS|URL|HTML|0|1|NONE)",{map:"escape"},")",")?","%s*","(?:","(?:DEFAULT)=","(?:","'([^'>]*)'|",{map:"default"},'"([^">]*)"|',{map:"default"},"([^%s=>]*)",{map:"default"},")",")?","%s*",">"]),e={};e.Base=c.defineClass({initialize:function(a){this.mergeOption(a)},mergeOption:function(a){c.merge(this,a),this.isCloseTag=this.isCloseTag?!0:!1},isParent:c.emptyFunction,execute:c.emptyFunction,getCode:function(a){return"void(0);"},toString:function(){return["<",this.isCloseTag?"/":"",this.type,this.hasName?" NAME=":"",this.name?this.name:"",">"].join("")},_pathLike:function(a,b){var c=b=="/"?"0":"$_C.length -"+(b.split("..").length-1);return["(($_C["+c+"]['",a,"']) ? $_C["+c+"]['",a,"'] : undefined )"].join("")},getParam:function(){var a="";if(this.attributes.name){var b=this.attributes.name.match(/^(\/|(?:\.\.\/)+)(\w+)/);if(b)return this._pathLike(b[2],b[1]);var c=this.attributes["default"]?"'"+this.attributes["default"]+"'":"undefined";a=["(($_T['",this.attributes.name,"']) ? $_T['",this.attributes.name,"'] : ",c," )"].join("")}if(this.attributes.expr){var d={gt:">",lt:"<",eq:"==",ne:"!=",ge:">=",le:"<="},e=this.attributes.expr.replace(/\{(\/|(?:\.\.\/)+)(\w+)\}/g,function(a,b,c){return["$_C[",b=="/"?"0":"$_C.length -"+(b.split("..").length-1),']["',c,'"]'].join("")}).replace(/\s+(gt|lt|eq|ne|ge|le|cmp)\s+/g,function(a,b){return" "+d[b]+" "});a=["(function(){","    with($_F){","        with($_T){","            return (",e,");","}}})()"].join("")}if(this.attributes.escape){var f={NONE:"NONE",0:"NONE",1:"HTML",HTML:"HTML",JS:"JS",URL:"URL"}[this.attributes.escape];a=["$_F.__escape"+f+"(",a,")"].join("")}return a}});var f={STRING_FRAGMENT:[]};c.merge(e,{ROOTElement:c.defineClass({type:"root",getCode:function(){return this.isCloseTag?'return $_R.join("");':["var $_R  = [];","var $_C  = [param];","var $_F  = funcs||{};","var $_T  = param||{};","var $_S  = cache.STRING_FRAGMENT;"].join("")}},e.Base),LOOPElement:c.defineClass({type:"loop",initialize:function(a){this.mergeOption(a)},getLoopId:function(){if(this._ID)return this._ID;e.LOOPElement.instanceId||(e.LOOPElement.instanceId=0);var a=e.LOOPElement.instanceId++;return this._ID="$"+a.toString(16),this._ID},getCode:function(){if(this.isCloseTag)return["}","$_T = $_C.pop();"].join("");var a=this.getLoopId();return["var $_L_"+a+" ="+this.getParam()+"|| [];","var $_LL_"+a+" = $_L_"+a+".length;","$_C.push($_T);","for(var i_"+a+"=0;i_"+a+"<$_LL_"+a+";i_"+a+"++){","   $_T = (typeof $_L_"+a+"[i_"+a+'] == "object")?',"                $_L_"+a+"[i_"+a+"] : {};","$_T['__first__'] = (i_"+a+" == 0) ? true: false;","$_T['__counter__'] = i_"+a+"+1;","$_T['__odd__']   = ((i_"+a+"+1)% 2) ? true: false;","$_T['__last__']  = (i_"+a+" == ($_LL_"+a+" - 1)) ? true: false;","$_T['__inner__'] = ($_T['__first__']||$_T['__last__'])?false:true;"].join("")}},e.Base),VARElement:c.defineClass({type:"var",getCode:function(){if(this.isCloseTag)throw new Error("HTML.Template ParseError TMPL_VAR");return"$_R.push("+this.getParam()+");"}},e.Base),IFElement:c.defineClass({type:"if",getCondition:function(a){return"!!"+this.getParam(a)},getCode:function(){return this.isCloseTag?"}":"if("+this.getCondition()+"){"}},e.Base),ELSEElement:c.defineClass({type:"else",getCode:function(){if(this.isCloseTag)throw new Error("HTML.Template ParseError No Close Tag for TMPL_ELSE");return"}else{"}},e.Base),INCLUDEElement:c.defineClass({type:"include",getCode:function(){if(this.isCloseTag)throw new Error("HTML.Template ParseError No Close Tag for TMPL_INCLUDE");var a='"'+this.attributes.name+'"';return["$_R.push($_F.__include(",a,",$_T,$_F));"].join("\n")}},e.Base),TEXTElement:c.defineClass({type:"text",isCloseTag:!1,initialize:function(a){this.value=a},getCode:function(){if(this.isCloseTag)throw new Error("HTML.Template ParseError No Close Tag for TEXT");return f.STRING_FRAGMENT.push(this.value),"$_R.push($_S["+(f.STRING_FRAGMENT.length-1)+"]);"}},e.Base)}),e.ELSIFElement=c.defineClass({type:"elsif",getCode:function(){if(this.isCloseTag)throw new Error("HTML.Template ParseError No Close Tag for TMPL_ELSIF");return"}else if("+this.getCondition()+"){"}},e.IFElement),e.UNLESSElement=c.defineClass({type:"unless",getCondition:function(a){return"!"+this.getParam(a)}},e.IFElement),e.createElement=function(a,b){return new e[a+"Element"](b)};var g=function(a){var b=[],c=e.createElement,f=c("ROOT",{isCloseTag:!1}),g=d;b.push(f);while(a.length>0){var h=g(a);if(!h){b.push(c("TEXT",a)),a="";break}var i=0,j=h.fullText;if((i=a.indexOf(j))>0){var k=a.slice(0,i);b.push(c("TEXT",k)),a=a.slice(i)}var l,m,n;h.attribute_name?(m=h.attribute_name.toLowerCase(),n=h.attribute_value,l={},l[m]=n,l["default"]=h["default"],l.escape=h.escape):l=undefined,b.push(c(h.tag_name,{attributes:l,isCloseTag:h.close,parent:this})),a=a.slice(j.length)}return b.push(c("ROOT",{isCloseTag:!0})),b};b.exports.getFunctionText=function(a){var b=c.isString(a)?g(a):a,d=[];for(var e=0,f=b.length;e<f;e++)d.push(b[e].getCode());return d.join("\n")},b.exports.compileFunctionText=function(a){return c.curry(new Function("cache","param","funcs",a),f)},a.provide(b.exports)}),Namespace("brook.view.htmltemplate").use("brook.view.htmltemplate.core *").define(function(a){var b=function(a,b){for(var c in b){if(!b.hasOwnProperty(c))continue;a[c]=b[c]}},c={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},d=function(a,b){var c=[];for(var d=0,e=a.length;d<e;d++)c.push(b(a[d]));return c},e=function(a){return'"'+d(a.split(""),function(a){return c[a]?c[a]:a}).join("")+'"'},f={__escapeHTML:function(a){return a.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},__escapeJS:function(a){return e(a)},__escapeURL:function(a){return encodeURI(a)},__escapeNONE:function(a){return a},__include:function(a,b,c){var d=g.getByElementId(a);if(!d)return;return d.param(b),d.registerFunction(c),d.output()}},g=function(a){this._param={},this._funcs={},b(this._funcs,f),this._output=a};b(g.prototype,{param:function(a){b(this._param,a)},registerFunction:function(a,b){this._funcs[a]=b},output:function(){return this._output(this._param,this._funcs)}});var h="Node"in window?Node.COMMENT_NODE:8,i=function(a){var b=a.childNodes||[],c=[];for(var d=0,e=b.length;d<e;d++){var f=b[d];if(f.nodeType!=h)continue;c.push(f.data)}return c.join("")},j=function(b){return a.getFunctionText(i(b))};b(g,{cache:{},get:function(b){var c="autocache:"+g.hashFunction(b),d=g.resolve(c);if(d)return new g(d);var e=a.getFunctionText(b),f=a.compileFunctionText(e);return new g(g.reserve(c,f))},resolve:function(a){return g.cache[a]},reserve:function(a,b){return g.cache[a]=b,g.cache[a]},getByElementId:function(b){var c="dom:"+b,d=g.resolve(c);if(d)return new g(d);var e=document.getElementById(b);if(!e)return undefined;var f=j(e),h=a.compileFunctionText(f);return new g(g.reserve(c,h))},hashFunction:function(a){var b=1<<31,c=a.length,d=34351,e="x";for(var f=0;f<c;f++){var g=a.charCodeAt(f);d*=37,e^=g,d+=g,d%=b}return d.toString(16)+"-"+(e&255).toString(16)},registerFunction:function(a,b){f[a]=b}}),a.provide({HTMLTemplate:g})}),Namespace("brook.dom.compat").define(function(a){var b=function(){var a=function(a){return a.dataset};if("HTMLElement"in window&&HTMLElement.prototype){var b=HTMLElement.prototype;if(b.dataset)return a;if(b.__lookupGetter__&&b.__lookupGetter__("dataset"))return a}var c=function(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})};return function(a){var b={};for(var d=0,e=a.attributes,f=e.length;d<f;d++){var g=e[d];if(!g.name.match(/^data-/))continue;b[c(g.name.replace(/^data-/,""))]=g.value}return b}}(),c=function(a){this._element=a,this._refresh()},d=function(a){return new c(a)};(function(a){var b=function(a){if(a==="")throw"SYNTAX_ERR";if(a.indexOf(/\s/)!=-1)throw"INVALID_CHARACTER_ERR"};this._fake=!0,this._refresh=function(){var a=(this._element.className||"").split(/\s+/);return a.length&&a[0]===""&&a.shift(),a.length&&a[a.length-1]===""&&a.pop(),this._classList=a,this.length=a.length,this},this.item=function(a){return this._classList[a]||null},this.contains=function(a){b(a);for(var c=0;c<this.length;++c)if(this._classList[c]==a)return!0;return!1},this.add=function(a){b(a);for(var c=0;c<this.length;++c)if(this._classList[c]==a)return;this._classList.push(a),this.length=this._classList.length,this._element.className=this._classList.join(" ")},this.remove=function(a){b(a);for(var c=0;c<this._classList.length;++c)this._classList[c]==a&&(this._classList.splice(c,1),this._element.className=this._classList.join(" "));this.length=this._classList.length},this.toggle=function(a){b(a);for(var c=0;c<this.length;++c)if(this._classList[c]==a)return this.remove(a),!1;return this.add(a),!0}}).apply(c.prototype);var e=function(a,b){var c=a.className;return!c||!b?!1:(new RegExp("(^|\\s)"+b+"(\\s|$)")).test(c)},f=function(a){if(document.getElementsByClassName)return document.getElementsByClassName(a);var b=document.getElementsByTagName("*"),c=[];for(var d=0,f=b.length;d<f;d++){if(!e(b[d],a))continue;c.push(b[d])}return c};a.provide({getElementsByClassName:f,hasClassName:e,dataset:b,classList:d})}),Namespace("brook.dom.gateway").define(function(a){a.provide({})}),Namespace("brook.widget").use("brook promise").use("brook.channel *").use("brook.util *").use("brook.dom.compat *").define(function(a){var b="widget",c=a.classList,d=a.dataset,e=a.channel("widget"),f=a.channel("error"),g=function(a,b){c(b).remove(a)},h=a.promise(function(c,d){d=d||b,c([d,Array.prototype.slice.call(a.getElementsByClassName(d))])}),i=a.promise(function(a,c){var e=c[0],f=c[1],h={};for(var i=0,j=f.length;i<j;i++){var k=f[i];g(e||b,k);var l=d(k),m=l.widgetNamespace;if(!m)continue;h[m]||(h[m]=[]),h[m].push([k,l])}a(h)}),j=a.promise(function(a,b){var c=[];for(var d in b)b.hasOwnProperty(d)&&c.push([d,b[d]]);a(c)}),k=a.promise(function(a,b){Namespace.use([b[0],"*"].join(" ")).apply(function(c){a([c,b[1]])})}),l=a.promise(function(a,b){var c=b[0],d=b[1],e,g;try{if(c.registerElement)for(e=0,g=d.length;e<g;e++)c.registerElement.apply(null,d[e]);else{if(!c.registerElements)throw"registerElement or registerElements not defined in "+c.CURRENT_NAMESPACE;var h=[];for(e=0,g=d.length;e<g;e++)h.push(d[e][0]);c.registerElements(h)}}catch(i){f.sendMessage(i)}}),m=a.promise().bind(a.lock("class-seek"),h,i,j,a.unlock("class-seek"),a.scatter(),k,l);e.observe(m),a.provide({bindAllWidget:e.send()})}),Namespace("brook.dom.event").use("brook promise").define(function(a){});